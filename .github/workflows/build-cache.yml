# Build cache tests for llgo
# Tests various build configurations to ensure cache works correctly

name: Build Cache

on:
  push:
    branches:
      - "**"
      - "!dependabot/**"
      - "!xgopilot/**"
  pull_request:
    branches: ["**"]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  build-cache:
    timeout-minutes: 30
    strategy:
      matrix:
        os: [macos-latest, ubuntu-latest]
        llvm: [19]
    runs-on: ${{matrix.os}}
    steps:
      - uses: actions/checkout@v6

      - name: Install dependencies
        uses: ./.github/actions/setup-deps
        with:
          llvm-version: ${{matrix.llvm}}

      - name: Set up Go
        uses: ./.github/actions/setup-go
        with:
          go-version: "1.24.2"

      - name: Install wamr (for wasm tests)
        if: startsWith(matrix.os, 'macos')
        run: |
          git clone --branch WAMR-2.4.4 --depth 1 https://github.com/bytecodealliance/wasm-micro-runtime.git
          mkdir wasm-micro-runtime/product-mini/platforms/darwin/build
          cd wasm-micro-runtime/product-mini/platforms/darwin/build
          cmake -D WAMR_BUILD_EXCE_HANDLING=1 -D WAMR_BUILD_FAST_INTERP=0 -DWAMR_BUILD_SHARED_MEMORY=1 -DWAMR_BUILD_LIB_WASI_THREADS=1 -DWAMR_BUILD_LIB_PTHREAD=1 -DCMAKE_BUILD_TYPE=Debug -DWAMR_BUILD_DEBUG_INTERP=1 ..
          make -j8
          echo "$PWD" >> $GITHUB_PATH

      - name: Install wamr (for wasm tests on Linux)
        if: startsWith(matrix.os, 'ubuntu')
        run: |
          git clone --branch WAMR-2.4.4 --depth 1 https://github.com/bytecodealliance/wasm-micro-runtime.git
          mkdir wasm-micro-runtime/product-mini/platforms/linux/build
          cd wasm-micro-runtime/product-mini/platforms/linux/build
          cmake -D WAMR_BUILD_EXCE_HANDLING=1 -D WAMR_BUILD_FAST_INTERP=0 -DWAMR_BUILD_SHARED_MEMORY=1 -DWAMR_BUILD_LIB_WASI_THREADS=1 -DWAMR_BUILD_LIB_PTHREAD=1 -DCMAKE_BUILD_TYPE=Debug -DWAMR_BUILD_DEBUG_INTERP=1 ..
          make -j8
          echo "$PWD" >> $GITHUB_PATH

      - name: Install llgo (dev mode)
        run: |
          go install -tags=dev ./cmd/llgo
          echo "LLGO_ROOT=$GITHUB_WORKSPACE" >> $GITHUB_ENV

      - name: Clear build cache
        run: |
          rm -rf ~/Library/Caches/llgo/build 2>/dev/null || true
          rm -rf ~/.cache/llgo/build 2>/dev/null || true

      - name: Test native build (run twice for cache test)
        working-directory: _demo/c/helloc
        run: |
          echo "=== Native build: first run ==="
          llgo build -o helloc -v .
          ./helloc
          echo "=== Native build: second run (cached) ==="
          llgo build -o helloc -v .
          ./helloc

      - name: Test native build with -a (force rebuild, run twice)
        working-directory: _demo/c/helloc
        run: |
          echo "=== Native build with -a: first run ==="
          llgo build -a -o helloc -v .
          ./helloc
          echo "=== Native build with -a: second run ==="
          llgo build -a -o helloc -v .
          ./helloc

      - name: Test native build with -gen-llfiles (run twice)
        working-directory: _demo/c/helloc
        run: |
          echo "=== Native build with -gen-llfiles: first run ==="
          llgo build -gen-llfiles -o helloc -v .
          ./helloc
          echo "=== Native build with -gen-llfiles: second run (cached) ==="
          llgo build -gen-llfiles -o helloc -v .
          ./helloc

      - name: Test native build with -gen-llfiles and -a (run twice)
        working-directory: _demo/c/helloc
        run: |
          echo "=== Native build with -gen-llfiles -a: first run ==="
          llgo build -gen-llfiles -a -o helloc -v .
          ./helloc
          echo "=== Native build with -gen-llfiles -a: second run ==="
          llgo build -gen-llfiles -a -o helloc -v .
          ./helloc

      - name: Clear cache before wasm tests
        run: |
          rm -rf ~/Library/Caches/llgo/build 2>/dev/null || true
          rm -rf ~/.cache/llgo/build 2>/dev/null || true

      - name: Test wasm build (run twice for cache test)
        working-directory: _demo/c/helloc
        run: |
          echo "=== WASM build: first run ==="
          GOOS=wasip1 GOARCH=wasm llgo build -o hello.wasm -tags=nogc -v .
          iwasm --stack-size=819200000 --heap-size=800000000 hello.wasm
          echo "=== WASM build: second run (cached) ==="
          GOOS=wasip1 GOARCH=wasm llgo build -o hello.wasm -tags=nogc -v .
          iwasm --stack-size=819200000 --heap-size=800000000 hello.wasm

      - name: Test wasm build with -a (force rebuild, run twice)
        working-directory: _demo/c/helloc
        run: |
          echo "=== WASM build with -a: first run ==="
          GOOS=wasip1 GOARCH=wasm llgo build -a -o hello.wasm -tags=nogc -v .
          iwasm --stack-size=819200000 --heap-size=800000000 hello.wasm
          echo "=== WASM build with -a: second run ==="
          GOOS=wasip1 GOARCH=wasm llgo build -a -o hello.wasm -tags=nogc -v .
          iwasm --stack-size=819200000 --heap-size=800000000 hello.wasm

      - name: Test wasm build with -gen-llfiles (run twice)
        working-directory: _demo/c/helloc
        run: |
          echo "=== WASM build with -gen-llfiles: first run ==="
          GOOS=wasip1 GOARCH=wasm llgo build -gen-llfiles -o hello.wasm -tags=nogc -v .
          iwasm --stack-size=819200000 --heap-size=800000000 hello.wasm
          echo "=== WASM build with -gen-llfiles: second run (cached) ==="
          GOOS=wasip1 GOARCH=wasm llgo build -gen-llfiles -o hello.wasm -tags=nogc -v .
          iwasm --stack-size=819200000 --heap-size=800000000 hello.wasm

      - name: Test wasm build with -gen-llfiles and -a (run twice)
        working-directory: _demo/c/helloc
        run: |
          echo "=== WASM build with -gen-llfiles -a: first run ==="
          GOOS=wasip1 GOARCH=wasm llgo build -gen-llfiles -a -o hello.wasm -tags=nogc -v .
          iwasm --stack-size=819200000 --heap-size=800000000 hello.wasm
          echo "=== WASM build with -gen-llfiles -a: second run ==="
          GOOS=wasip1 GOARCH=wasm llgo build -gen-llfiles -a -o hello.wasm -tags=nogc -v .
          iwasm --stack-size=819200000 --heap-size=800000000 hello.wasm

      - name: Summary
        run: |
          echo "All build cache tests passed!"
          echo ""
          echo "Tested configurations:"
          echo "  - Native: normal, -a, -gen-llfiles, -gen-llfiles -a"
          echo "  - WASM:   normal, -a, -gen-llfiles, -gen-llfiles -a"
          echo ""
          echo "Each configuration was run twice to verify cache behavior."
