# Build cache tests for llgo
# Tests various build configurations to ensure cache works correctly

name: Build Cache

on:
  push:
    branches:
      - "**"
      - "!dependabot/**"
      - "!xgopilot/**"
  pull_request:
    branches: ["**"]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  build-cache:
    timeout-minutes: 30
    strategy:
      matrix:
        os: [macos-latest, ubuntu-latest]
        llvm: [19]
    runs-on: ${{matrix.os}}
    steps:
      - uses: actions/checkout@v6

      - name: Install dependencies
        uses: ./.github/actions/setup-deps
        with:
          llvm-version: ${{matrix.llvm}}

      - name: Set up Go
        uses: ./.github/actions/setup-go
        with:
          go-version: "1.24.2"

      - name: Install wamr (for wasm tests)
        if: startsWith(matrix.os, 'macos')
        run: |
          git clone --branch WAMR-2.4.4 --depth 1 https://github.com/bytecodealliance/wasm-micro-runtime.git
          mkdir wasm-micro-runtime/product-mini/platforms/darwin/build
          cd wasm-micro-runtime/product-mini/platforms/darwin/build
          cmake -D WAMR_BUILD_EXCE_HANDLING=1 -D WAMR_BUILD_FAST_INTERP=0 -DWAMR_BUILD_SHARED_MEMORY=1 -DWAMR_BUILD_LIB_WASI_THREADS=1 -DWAMR_BUILD_LIB_PTHREAD=1 -DCMAKE_BUILD_TYPE=Debug -DWAMR_BUILD_DEBUG_INTERP=1 ..
          make -j8
          echo "$PWD" >> $GITHUB_PATH

      - name: Install wamr (for wasm tests on Linux)
        if: startsWith(matrix.os, 'ubuntu')
        run: |
          git clone --branch WAMR-2.4.4 --depth 1 https://github.com/bytecodealliance/wasm-micro-runtime.git
          mkdir wasm-micro-runtime/product-mini/platforms/linux/build
          cd wasm-micro-runtime/product-mini/platforms/linux/build
          cmake -D WAMR_BUILD_EXCE_HANDLING=1 -D WAMR_BUILD_FAST_INTERP=0 -DWAMR_BUILD_SHARED_MEMORY=1 -DWAMR_BUILD_LIB_WASI_THREADS=1 -DWAMR_BUILD_LIB_PTHREAD=1 -DCMAKE_BUILD_TYPE=Debug -DWAMR_BUILD_DEBUG_INTERP=1 ..
          make -j8
          echo "$PWD" >> $GITHUB_PATH

      - name: Install llgo (dev mode)
        run: |
          go install -tags=dev ./cmd/llgo
          echo "LLGO_ROOT=$GITHUB_WORKSPACE" >> $GITHUB_ENV

      - name: Run build cache tests
        run: bash test/buildcache/test.sh
