# This workflow will build a golang project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-go

name: LLGo

on:
  push:
    branches:
      - "**"
      - "!dependabot/**"
      - "!xgopilot/**"
  pull_request:
    branches: ["**"]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  llgo:
    continue-on-error: true
    timeout-minutes: 30
    strategy:
      matrix:
        os:
          - macos-latest
          - ubuntu-latest
        llvm: [19]
        go: ["1.21.13", "1.22.12", "1.23.6", "1.24.2"]
    runs-on: ${{matrix.os}}
    steps:
      - uses: actions/checkout@v5
      - name: Install dependencies
        uses: ./.github/actions/setup-deps
        with:
          llvm-version: ${{matrix.llvm}}
      - name: Download platform-specific demo libs
        run: |
          if ${{ startsWith(matrix.os, 'macos') }}; then
            DEMO_PKG="cargs_darwin_arm64.zip"
          else
            DEMO_PKG="cargs_linux_amd64.zip"
          fi

          mkdir -p ./_demo/c/cargs/libs
          cd ./_demo/c/cargs/libs
          wget https://github.com/goplus/llpkg/releases/download/cargs/v1.0.0/${DEMO_PKG}
          unzip ${DEMO_PKG}

          # Process pc template files - replace {{.Prefix}} with actual path
          ACTUAL_PREFIX="$(pwd)"
          for tmpl in lib/pkgconfig/*.pc.tmpl; do
            pc_file="${tmpl%.tmpl}"
            sed "s|{{.Prefix}}|${ACTUAL_PREFIX}|g" "$tmpl" > "$pc_file"
          done

          echo "PKG_CONFIG_PATH=${ACTUAL_PREFIX}/lib/pkgconfig:${PKG_CONFIG_PATH}" >> $GITHUB_ENV
      - name: Set up Go for build
        uses: ./.github/actions/setup-go
        with:
          go-version: "1.24.2"

      - name: Install
        run: |
          go install ./...
          go build -o _demo/gogen/gogen-test ./_demo/gogen
          echo "LLGO_ROOT=$GITHUB_WORKSPACE" >> $GITHUB_ENV

      - name: Set up Go for testing
        uses: actions/setup-go@v6
        with:
          go-version: ${{matrix.go}}

      - name: Test GoGen dependency coverage with go
        run: |
          echo "Testing GoGen dependencies with go compiler..."
          cd _demo/gogen
          ./gogen-test --compiler=go | tee go-coverage.txt
          echo "✓ GoGen test with go completed"

      - name: Test GoGen dependency coverage with llgo
        run: |
          echo "Testing GoGen dependencies with llgo compiler..."
          cd _demo/gogen
          ./gogen-test --compiler=llgo | tee llgo-coverage.txt
          echo "✓ GoGen test with llgo completed"
